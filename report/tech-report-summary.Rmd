---
title: "Filling the gaps: using simulation to test model-based solutions to survey problems"
output:
  bookdown::pdf_document2:
    toc: false
    number_sections: false
    fig_caption: true
    highlight: "monochrome"
---

```{r setup, include = FALSE, message=FALSE, warning=FALSE, error=FALSE}
library(dplyr)
library(here)
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  out.width = "4.2in",
  fig.align='center'
)
```

# Participants

```{r echo = FALSE, results='asis'}
p <- tribble(~first, ~last, ~affil, ~role,
"Sean", "Anderson", "DFO Pacific", "Lead",
"Paul", "Regular", "DFO Newfoundland", "Lead",
"Alex", "Hanke", "DFO Gulf", "Participant",
"Brooke", "Biddlecombe", "DFO Arctic/University of Manitoba", "Participant",
"Dan", "Ricard", "DFO Gulf", "Participant",
"Daniel", "Duplisea", "DFO Québec", "Participant",
"Elisabeth", "Van Beveren", "DFO Québec", "Participant",
"Fatemeh", "Hatefi", "DFO Newfoundland/Memorial University", "Participant",
"Hannah", "Munro", "DFO Newfoundland", "Participant",
"Jordan", "Ouellette-Plante", "DFO Québec", "Participant",
"Kevin", "Hedges", "DFO Arctic", "Participant",
"Kotaro", "Ono", "Institute of Marine Research, Norway", "Participant",
"Kyle", "Gillespie", "DFO Maritimes", "Participant",
"Laura", "Bianucci", "DFO Pacific", "Participant",
"Liza", "Tsitrin", "DFO Maritimes", "Participant",
"Marie-Julie", "Roux", "DFO Québec", "Participant",
"Mark", "Billard", "Acadia University", "Participant",
"Mathieu", "Boudreau", "DFO Québec", "Participant",
"Meghan", "Burton", "DFO Pacific", "Participant",
"Michelle", "Fitzsimmons", "DFO Newfoundland", "Participant",
"Michelle", "Greenlaw", "DFO Gulf", "Participant",
"Philina", "English", "DFO Pacific", "Participant",
"Quang", "Huynh", "Blue Matter Science", "Participant",
"Rajeev", "Kumar", "DFO Newfoundland", "Participant",
"Ross", "Tallman", "DFO Arctic", "Participant",
"Shani", "Rousseau", "DFO Québec", "Participant",
"Shannon", "Obradovich", "DFO Pacific", "Participant",
"Stephane", "Gauthier", "DFO Pacific", "Participant",
"Tom", "Bermingham", "DFO Québec", "Participant",
"Wayne", "Hajas", "DFO Pacific", "Participant",
"Xinhua", "Zhu", "DFO Arctic", "Participant"
)
p %>% arrange(last) %>% 
  mutate(name = paste(first, last)) %>% 
  select(-first, -last, -role) %>%
  select(name, affil) %>% 
  knitr::kable(col.names = c("Name", "Affiliation"), booktabs = TRUE, linesep = "")
```

# Background

There has been a recent movement towards geostatistical model-based calibration of survey data to assess trends in species abundance and evaluate distribution shifts.
Such a spatial approach can increase precision compared to design-based approaches and has the potential to account for common survey problems (e.g., gear changes, partial coverage) in calculating indices used in stock assessment.
Furthermore, geostatistical models provide a framework for integrating data from contiguous surveys, meeting an urgent need to track species across survey domains and geopolitical borders as changing ocean conditions cause distributional shifts.
However, skepticism about such approaches remains.
Simulation testing has typically been under ideal conditions (e.g., self-testing with the same underlying model) or non-existent.
Complications exist such as differing length-selectivity and spatiotemporal coverage.

In this breakout group, we proposed joining two major ongoing software development efforts at DFO---one a simulation tool (SimSurvey) and one a model fitting tool (sdmTMB)---to use simulation testing to address several questions around the use of geostatistical model-based calibration of survey data. Specifically, we proposed four subgroups to address the following questions:

1. Does including a covariate (e.g., depth) increase precision, estimate the right depth relationship, and maintain an unbiased index with greater precision compared to not including any covariates? Are there scenarios where that is or isn't the case?

2. Changes to spatial coverage from year to year: If part of the survey (e.g. multiple strata, half the survey area) is missed in some years, can the model recover the index and with appropriate confidence intervals?

3. If two surveys with different catchabilities are conducted in parallel at neighbouring regions, could a model "stitch" these surveys together to provide a unified estimate of the population?


# Methods and results

The general approach taken across subgroups:

1. Simulate a population and survey and calculate design-based indices using SimSurvey.
2. Degrade the survey if needed (e.g., dropping some spatial coverage).
3. Fit a geostistical spatiotemporal model to the simulated survey data using sdmTMB to obtain model-based indices.
4. Iterate over multiple stochastic realizations of the population and survey and model fitting.
5. Visually and possibly quantitatively assess the bias and precision of the estimates compared to the known truth.
6. Modify the simulation settings (e.g., impose partial survey coverage or add observation error) and repeat steps 1--5.

The overall group split into four subgroups. Two groups investigated question one (covariate effects), one group investigated question two (reduced survey coverage), and one group investigated question three ("stitching" surveys with different catch abilities).

The workshop leaders provided prototype code to help kickstart the subgroup explorations.

# Discussion

Challenges included the limited amount of time for the project, the virtual setting, challenges for users working with packages that they were not yet familiar with, computational demands give in the limited time, visualizing high dimensional problems and summarizing results.

The groups spent considerable time brainstorming and most groups achieved some preliminary results.

The expected outcomes included a GitHub repository with code to  work through basic versions of the questions proposed, having the participants gained some familiarity with the tools, obtaining ideas for additional functionality in SimSurvey, and brainstorming interesting questions that could be explored in the future.

# References

# Preliminary results from sub-groups

One of the covariate subgroups (subgroup coding led by P. English) found that sdmTMB was able to resolve the underlying depth preference as simulated in SimSurvey reasonably well (Fig. \@ref(fig:depth1)).
In their simulation testing, they found that adding a depth covariate reduced population index uncertainty when compared to a model that did not have a depth covariate (Fig. \@ref(fig:depth3)).

```{r depth1, echo = FALSE, fig.cap="(Left) Simulated depth within the SimSurvey population simulation. (Right) Known depth relationship (dashed red) and estimated depth relationship from the geostatistical model (black and grey).", out.width=c("2.72in", "3in"), fig.show='hold'}
knitr::include_graphics(c(here("report/real-depth-profile.png"), here("report/depth-estimate.png")))
```

```{r depth3, echo = FALSE, fig.cap="Population indexes with and without a depth covariate. True index is indicated with a dotted red line, design-based estimate is shown witha  green line, model-based (without depth) is indicated by a blue line and ribbon, model-based (with depth) is indicated by a purple line and ribbon. Lines indicate means and ribbons indicate 95\\% confidence intervals (CIs)."}
knitr::include_graphics(here("report/covariate-sims-w-real-depth.png"))
```

The subgroup working on joining or stitching nearby surveys (subgroup coding led by Q. Huynh) designed a series of experiments to evaluate the effects of sampling from two possible areas in various years. Here, we focus on two scenarios: (Q2) surveys A and B have different catchabilities and each sample different areas in alternate years and (Q4) same as Q2 but the terminal year includes samples from both surveys A and B (Fig. \@ref(fig:cal-year)). Using a geostatistical model with spatial random fields and independent spatiotemporal random fields for each year, the subgroup found that including the calibration year (Q4) greatly improved the ability to recover the index (Fig. \@ref(fig:stitchQ2) vs. Fig. \@ref(fig:stitchQ4)). Subsequent work has suggested that other structural forms to the random fields can improve stitching performance further.

```{r cal-year, echo = FALSE, fig.cap="Example of alternating surveys in alternate years with a calibrating year (Q4)."}
knitr::include_graphics(here("stitching/stitched_design.png"))
```

```{r stitchQ2, echo = FALSE, fig.cap="Four iterations (columns) of calculating population indexes from two alternating surveys with different catchabilities in alternate years and no calibration year (Q2)."}
knitr::include_graphics(here("stitching/stitch_iter_Q2.png"))
```

```{r stitchQ4, echo = FALSE, fig.cap="Four iterations (columns) of calculating population indexes from two alternating surveys in alternate years \\textbf{with} a calibrating year (Q4). The `global model' (red) does not estimate a separate catchability for each survey whereas the `stitch A/B' model does."}
knitr::include_graphics(here("stitching/stitch_iter_Q4.png"))
```

The subgroup working on the effects of reduced coverage on survey indices spent time developing a full simulation experiment but ran out of time running the models to have results before the end of the workshop.
In place of those results, we have included output from the prototype code.
In this example, a survey was run for 10 years but the survey could not cover a quarter of the survey domain in years 2, 4, and 8 (Fig. \@ref(fig:coverage-exp)).
The fitted spatiotemporal model attempted to spatially extrapolate over the missing area and generally produced reasonable estimates and confidence intervals (Fig. \@ref(fig:coverage)).
The confidence intervals on the missing years were often larger given the reduced spatial coverage (Fig. \@ref(fig:coverage)).

```{r coverage-exp, echo = FALSE, fig.cap="Simulation experiment in which the survey was excluded from one quarter of the survey domain in years 2, 4, and 8. Dots represent survey set locations in space and panels represent years."}
knitr::include_graphics(here("report/coverage-sample.png"))
```

```{r coverage, echo = FALSE, fig.cap="Resulting indexes calculated from the survey with reduced survey coverage in three years. Red lines represent the true known index value. Blue line represents the design-based index calculated for the entire survey domain (i.e., seeing the missing data). Black line and shaded area represents the geostatistical model-based index and confidence interval. The dashed vertical lines indicate years with missing data."}
knitr::include_graphics(here("report/reduced-coverage-index.png"))
```
